# Explanation of optimization
## Creating table and importing data
### Data was found on Kaggle
This is the link for the dataset: [Bike Sales Data](https://www.kaggle.com/datasets/jayavarman/bike-sales-data-of-100k)\
Then I manually wrote properties for creating table (look [creating.sql](../query_versions/creating.sql) file) \
File content importing was made through DBeaver built-in tool:\
![img.png](img.png)

## Original query
#### *was generated by ChatGPT-4o model 

An unoptimized querry
 ```sql
SELECT
    customer_id,
    sale_date,
    bike_model,
    price,
    quantity,
    (SELECT AVG(price) FROM bike_sales_data WHERE bike_model = b.bike_model) AS avg_bike_price,
    (SELECT COUNT(*) FROM bike_sales_data WHERE customer_id = b.customer_id AND sale_date > '2023-01-01') AS recent_purchases,
    (price * quantity) AS total_sale_value
FROM 
    bike_sales_data b
WHERE
    price > (SELECT AVG(price) FROM bike_sales_data)
    AND quantity > (
        SELECT AVG(quantity) FROM bike_sales_data WHERE bike_model = b.bike_model
    )
ORDER BY 
    sale_date DESC, customer_id;
```
## Step 1: Refactoring
### Making CTEs from subqueries
#### This optimization step helps to avoid repeated selecting same part of code for each row.
Instead, it selects code only once and save it as CTE.

From:
````sql
(SELECT AVG(price) FROM bike_sales_data WHERE bike_model = b.bike_model) AS avg_bike_price
(SELECT COUNT(*) FROM bike_sales_data WHERE customer_id = b.customer_id AND sale_date > '2023-01-01') AS recent_purchases
(SELECT AVG(quantity) FROM bike_sales_data WHERE bike_model = b.bike_model)
````
To:
````sql
with avg_bike_price as (
	SELECT bike_model, AVG(price) as avg_price
	FROM bike_sales_data
	group by bike_model
),
recent_purchases as (
	SELECT customer_id, COUNT(*) as recent_purchases_count 
	FROM bike_sales_data 
	where sale_date > '2023-01-01'
	group by customer_id
),
avg_quantity as (
	SELECT bike_model, AVG(quantity) as average_quantity
	FROM bike_sales_data 
	group by bike_model
)
...
    left join avg_bike_price abp on b.bike_model = abp.bike_model
    left join recent_purchases rp on b.customer_id = rp.customer_id
    left join avg_quantity aq on b.bike_model = aq.bike_model
````
## Step 2: Indexing
### Creating indexes to optimize query
#### This step helps to analyze smaller number of rows

#### 1:
````sql
create index bike_model_index on bike_sales_data (bike_model);
````
This index helps with <span style="color: darkorange;">group by</span> operation in CTEs and <span style="color: darkorange;">left join</span> on bike model name.
#### 2:
````sql
create index sale_date_customer_id_index on bike_sales_data(sale_date, customer_id);
````
This composite index helps in CTE:
````sql
where sale_date > '2023-01-01'
group by customer_id
````
Also, it helps while ordering:
````sql
ORDER BY b.sale_date DESC, b.customer_id
````
